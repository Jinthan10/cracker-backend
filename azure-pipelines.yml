trigger:
- main  # or your default branch name

pool:
  name: Default  # use your agent pool name

variables:
  ACR_NAME: 'backendapli'          # your Azure Container Registry name
  IMAGE_NAME: 'backendapp'         # your app image name
  TAG: 'latest'
  SONAR_PROJECT_KEY: 'backendapp'
  SONAR_PROJECT_NAME: 'BackendApp'
  SONAR_HOST_URL: 'http://192.168.1.12:9001'   # your SonarQube container IP:port
  SONAR_TOKEN: 'squ_4e00ff1c3c5dc6e55cfe450fe4427ed6df80d4e0'  # your generated token

stages:
- stage: BuildAndScan
  displayName: "Build Docker Image and Run SonarQube Scan"
  jobs:
  - job: BuildJob
    displayName: "Build and Scan Code"
    steps:

    # Step 1 — Checkout code
    - checkout: self

    # Step 2 — Run SonarQube Scan inside Docker
    - powershell: |
        Write-Host "Starting SonarQube scan..."
        docker run --rm `
          -v "$(Build.SourcesDirectory):/usr/src" `
          sonarsource/sonar-scanner-cli `
          -Dsonar.projectKey=$(SONAR_PROJECT_KEY) `
          -Dsonar.projectName=$(SONAR_PROJECT_NAME) `
          -Dsonar.sources=/usr/src `
          -Dsonar.host.url=$(SONAR_HOST_URL) `
          -Dsonar.login=$(SONAR_TOKEN)
      displayName: "Run SonarQube Scan via Docker"

    # Step 3 — Build & Push Docker Image (optional)
    - task: Docker@2
      displayName: "Build and Push Docker Image to ACR"
      inputs:
        containerRegistry: 'mypip1'   # your ACR service connection
        repository: '$(ACR_NAME).azurecr.io/$(IMAGE_NAME)'
        command: buildAndPush
        dockerfile: 'cracker-backend/Dockerfile'
        buildContext: 'cracker-backend'
        tags: |
          $(TAG)
