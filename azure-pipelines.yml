trigger:
- main  # your default branch

pool:
  name: Default  # Replace with your self-hosted agent pool name
  # Optional: make sure agent has docker installed
  demands:
    - docker

variables:
  # Docker / ACR
  ACR_NAME: 'backendapli'
  IMAGE_NAME: 'backendapp'
  TAG: 'latest'

  # SonarQube
  SONAR_PROJECT_KEY: 'backendapp'
  SONAR_PROJECT_NAME: 'BackendApp'
  SONAR_HOST_URL: 'http://192.168.1.12:9001'  # Your SonarQube container IP
  SONAR_TOKEN: 'squ_4e00ff1c3c5dc6e55cfe450fe4427ed6df80d4e0'  # Secret variable recommended

stages:
- stage: BuildAndScan
  displayName: "Build Docker Image & SonarQube Scan"
  jobs:
  - job: BuildJob
    displayName: "Build and Scan Backend"
    steps:

    # 1️⃣ Checkout code and fetch master branch
    - checkout: self
      clean: true
      persistCredentials: true
      fetchDepth: 0  # full fetch

    - script: |
        git fetch origin master
        git checkout master
        git reset --hard origin/master
      displayName: 'Checkout master branch'

    # 2️⃣ Run SonarQube Scanner in Docker
    - powershell: |
        echo "Starting SonarQube scan..."
        docker run --rm `
          -v "$(Build.SourcesDirectory):/usr/src" `
          sonarsource/sonar-scanner-cli `
          -D"sonar.projectKey=$(SONAR_PROJECT_KEY)" `
          -D"sonar.projectName=$(SONAR_PROJECT_NAME)" `
          -D"sonar.sources=/usr/src" `
          -D"sonar.host.url=$(SONAR_HOST_URL)" `
          -D"sonar.login=$(SONAR_TOKEN)"
      displayName: 'Run SonarQube Scan via Docker'

    # 3️⃣ Build & Push Docker Image to Azure Container Registry
    - task: Docker@2
      displayName: "Build & Push Docker Image"
      inputs:
        containerRegistry: 'mypip1'  # Azure service connection for ACR
        repository: '$(ACR_NAME).azurecr.io/$(IMAGE_NAME)'
        command: buildAndPush
        dockerfile: 'cracker-backend/Dockerfile'  # Adjust path if needed
        buildContext: 'cracker-backend'
        tags: |
          $(TAG)
