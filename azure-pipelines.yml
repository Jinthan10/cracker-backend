trigger:
- main  # pipeline triggers when YAML changes in main branch

pool:
  name: Default  # replace with your self-hosted agent pool name
  demands:
    - docker  # ensures agent has Docker installed

variables:
  # Azure Container Registry
  ACR_NAME: 'backendapli'
  IMAGE_NAME: 'backendapp'
  TAG: 'latest'

  # SonarQube variables
  SONAR_PROJECT_KEY: 'backendapp'
  SONAR_PROJECT_NAME: 'BackendApp'
  SONAR_HOST_URL: 'http://192.168.1.12:9001'  # IP of your SonarQube container
  SONAR_TOKEN: 'squ_4e00ff1c3c5dc6e55cfe450fe4427ed6df80d4e0'  # mark as secret

stages:
- stage: BuildAndScan
  displayName: "Build Docker Image & SonarQube Scan"
  jobs:
  - job: BuildJob
    displayName: "Build Backend and Run SonarQube"
    steps:

    # 1️⃣ Checkout the repository
    - checkout: self
      clean: true
      persistCredentials: true
      fetchDepth: 0  # fetch full history

    # 2️⃣ Ensure master branch is checked out
    - powershell: |
        Write-Host "Switching to master branch..."
        git fetch origin master
        git checkout master
        git reset --hard origin/master
      displayName: 'Checkout master branch'

    # 3️⃣ Run SonarQube Scanner in Docker
    - powershell: |
        Write-Host "Running SonarQube scan..."
        docker run --rm `
          -v "$(Build.SourcesDirectory):/usr/src" `
          sonarsource/sonar-scanner-cli `
          -D"sonar.projectKey=$(SONAR_PROJECT_KEY)" `
          -D"sonar.projectName=$(SONAR_PROJECT_NAME)" `
          -D"sonar.sources=/usr/src" `
          -D"sonar.host.url=$(SONAR_HOST_URL)" `
          -D"sonar.login=$(SONAR_TOKEN)"
      displayName: 'SonarQube Scan via Docker'

    # 4️⃣ Build and Push Docker Image to ACR
    - task: Docker@2
      displayName: "Build & Push Docker Image"
      inputs:
        containerRegistry: 'mypip1'  # Azure service connection for ACR
        repository: '$(ACR_NAME).azurecr.io/$(IMAGE_NAME)'
        command: buildAndPush
        dockerfile: 'cracker-backend/Dockerfile'  # adjust path if needed
        buildContext: 'cracker-backend'
        tags: |
          $(TAG)
