steps:
# 1️⃣ Checkout correct branch
- checkout: self
  clean: true
  persistCredentials: true

- script: |
    git fetch origin master
    git checkout master
    git reset --hard origin/master
  displayName: 'Checkout master branch'

# 2️⃣ SonarQube scan (Docker)
- powershell: |
    docker run --rm `
      -v "$(Build.SourcesDirectory):/usr/src" `
      sonarsource/sonar-scanner-cli `
      -D"sonar.projectKey=$(SONAR_PROJECT_KEY)" `
      -D"sonar.projectName=$(SONAR_PROJECT_NAME)" `
      -D"sonar.sources=/usr/src" `
      -D"sonar.host.url=$(SONAR_HOST_URL)" `
      -D"sonar.login=$(SONAR_TOKEN)"
  displayName: 'Run SonarQube Scan via Docker'

# 3️⃣ Docker build & push
- task: Docker@2
  displayName: "Build & Push Docker Image"
  inputs:
    containerRegistry: 'mypip1'
    repository: '$(ACR_NAME).azurecr.io/$(IMAGE_NAME)'
    command: buildAndPush
    dockerfile: 'cracker-backend/Dockerfile'
    buildContext: 'cracker-backend'
    tags: |
      $(TAG)
